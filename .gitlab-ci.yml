stages:
  - machines

k3d:
  stage: machines
  image: registry.access.redhat.com/ubi8/ubi:8.3
  variables:
    CLUSTER_NAME: tester
  tags:
    - bigbang
    - machine
  services:
    - registry.dsop.io/platform-one/big-bang/pipeline-templates/pipeline-templates/docker:dind
  before_script:
    - curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl && mv kubectl /usr/local/bin/kubectl
    - curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash
  script:
    - k3d cluster create ${CLUSTER_NAME}  --k3s-server-arg "--disable=traefik" --k3s-server-arg "--disable=metrics-server" -p 80:80@loadbalancer -p 443:443@loadbalancer --wait
    - while ! (kubectl get node | grep "server" > /dev/null); do sleep 3; done
    - kubectl get nodes
    - k3d node list