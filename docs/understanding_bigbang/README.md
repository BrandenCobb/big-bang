# Useful Background Contextual Information: 


## The purpose of this section is to help consumers of BigBang understand:
* BigBang's scope: what it is and isn't, goals and non-goals
* The value add gained by using BigBang
* What to expect in terms of prerequisites for those interested in using BigBang
* Help those who want a deep drive concrete understanding of BigBang quickly come up to speed, via pre-reading materials, that can act as a self service new user orientation to point out features and nuances that new users wouldn't know to ask about. 


## BigBang's scope: what it is and isn't, goals and non-goals 
### What BigBang is:
* BigBang is a Helm Chart that is used to deploy a DevSecOps Platform composed of IronBank hardened container images on a Kubernetes Cluster.
* See [/docs/README.md](../README.md#what-is-bigbang?) more details.

### What BigBang isn't:
* BigBang by itself is not intended to be an End to End Secure Kubernetes Cluster Solution, but rather a reusable secure component/piece of a full solution. 
* A Secure Kubernetes Cluster Solution, will have multiple components, that can each be swapable and in some cases considered optional depending on use case and risk tolerance: 
  Example of some potential components in a full End to End Solution: 
  * P1's Cloud Native Access Point to protect Ingress Traffic. (This can be swapped with an equivalent, or considered optional in an internet disconnected setup.)
  * Hardened Host OS
  * Hardened Kubernetes Cluster (BigBang assumes ByoC, Bring your own Cluster)
  * Hardened Applications running on the Cluster (BigBang helps solve this component)


## Value add gained by using BigBang: 
* Compliant with the [DoD DevSecOps Reference Architecture Design](https://dodcio.defense.gov/Portals/0/Documents/DoD%20Enterprise%20DevSecOps%20Reference%20Design%20v1.0_Public%20Release.pdf)
* Can be used to check some but not all of the boxes needed to achieve a cATO (Continuous Authority to Operate.)
* Uses hardened IronBank Container Images. (left shifted security concern)
* Lowers maintainability overhead involved in keeping the images of the DevSecOps Platform's up to date and maintaining a secure posture over the long term. This is achieved by pairing the GitOps pattern with the Umbrella Helm Chart Pattern.        
  Let's walk through an example:       
  * Initially a kustomization.yaml file in a git repo will tell the Flux GitOps operator (software deployment bot running in the cluster), to deploy version 1.0.0 of BigBang. BigBang could deploy 10 helm charts. And each helm chart could deploy 10 images. (So BigBang is managing 100 container images in this example.)
  * After a 2 week sprint version 1.1.0 of BigBang is released. A BigBang consumer updates the kustomization.yaml file in their git repo to point to version 1.1.0 of the BigBang Helm Chart. That triggers an update of 10 helm charts to a new version of the helm chart. Each updated helm chart will point to newer versions of the container images managed by the helm chart. 
  * So when the end user edits the version of 1 kustomization.yaml file, that triggers a chain reaction that updates 100 container images. 
  * These upgrades are pre-tested. The BigBang team "eats our own dogfood". Our CI jobs for developing the BigBang product, run against a BigBang dogfood Cluster, and as part of our release process we upgrade our dogfood cluster, before publishing each release. (Note: We don't test upgrades that skip multiple minor versions.)
* Auto Update support to help with Zero Day Vulnerabilities:       
Normally consumers of BigBang should update every 2 weeks (our release cadence). In the event of zero day vulnerabilities, the BigBang team can push a mid-sprint patch release. Consumers of BigBang interested in Zero Day Vulnerability auto updates can set their kustomization.yaml to 1.1.x (We follow semantic versioning which means that the x in 1.1.x represents a backwords compatible safe security patch update). Flux understands semantic versioning and can auto update to the latest patch release as soon as it's available. 
* DoD Software Developers get a Developer User Experience of "SSO for free". Instead of developers coding SSO support 10 times for 10 apps. The complexity of SSO support is baked into the platform, and after an Ops team correctly configures the Platform's SSO settings, SSO works for all apps hosted on the platform. The developer's user experience for enabling SSO for their app then becomes as simple as adding the label istio-injection=enabled (which transparently injects mTLS service mesh protection into their application's Kubernetes YAML manifest) and adding the label protect=keycloak to each pod, which leverages an EnvoyFilter CustomResource to auto inject an SSO Authentication Proxy in front of the data path to get to their application. 


## Acronyms:
* CSP: Cloud Service Provider 
* L4 LB: Layer 4 Load Balancer
* KMS: Key Management System / Encryption as a Service (AWS/GCP KMS, Azure Key Vault, HashiCorp Transient Secret Engine)
* PGP: Pretty Good Privacy (Assymetric Encryption Key Pair, where public key is used to encrypt, private key used to decrypt)
* SOPS: "Secret Operations" CLI tool by Mozilla, leverages KMS or PGP to encrypt secrets in a Git Repo. (Flux and P1's modified ArgoCD can use SOPS to decrypt secrets stored in a Git Repo.)
* cATO: continuous Authority to Operate
* AO: Authorizing Official (Government Official who determines OS and Kubernetes Cluster hardening requirements, that result in a level of acceptable remaining risk that they're willing to sign off on for a Kubernetes Cluster to recieve an ATO, and a BigBang Cluster to recieve a cATO)
* IaC: Infrastructure as Code
* CaC: Configuration as Code
* CAC: Common Access Card  


## Prerequisites:
* Prerequisites vary depending on deployment scenario
* This is meant to be a high level overview of prerequsites, per scenario guides will go into more detail.
* Note for future edits: The following table was generated using tablesgenerator.com, recommended to copy the table's raw text contents, visit tablesgenerator.com, and File -> Paste table data when edits are needed.

| Prerequsites(rows) vs Deployment Scenarios(columns)                                                                                                              | QuickStart                                                                                                                                                                                                                                                                                                  | Internet Connected                                                                                                                                                                                           | Internet Disconnected                                                                                                                                                                                                       |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| OS Preconfigured (1*) and Prehardened (OS and level of hardening required depends on AO)                                                                         | pre-req (non-hardened large CPU and RAM single node machine is recommended for demos)                                                                                                                                                                                                                       | CSPs usually have marketplaces with pre-hardened VM images                                                                                                                                                   | pre-req                                                                                                                                                                                                                     |
| Kubernetes Distribution Preconfigured to Best Practices (2*) and Prehardened (Any CNCF Kubernetes Distribution will work as long as an AO signs off on it)       | k3d is recommended for demos (It's quick to set up, works on every cloud and bare metal)                                                                                                                                                                                                                    | https://repo1.dso.mil/platform-one/distros                                                                                                                                                                   | pre-req (users are responsible for airgap image import of container images needed by chosen Kubernetes Distribution)                                                                                                        |
| Default Storage Class (for Dynamic PVCs)                                                                                                                         | k3d has dynamic local volume storage class baked in                                                                                                                                                                                                                                                         | In most cases it's recommended to use a CSP specific storage class                                                                                                                                           | [BB Product team did a Cloud Agnostic Storage Solution research spike](https://repo1.dso.mil/platform-one/big-bang/bigbang/-/issues/260), (Note: No storage class specific container images exist in IronBank at this time) |
| Support for Automated Provisioning of Service Type Load Balancer is recommended                                                                                  | k3d ships with the ability to treat the VM's port 443 as Kubernetes Service of Type LB's port 443, automation in the quick start repo leverages these flags.                                                                                                                                                | CSPs usually include flags you can pass to the kube-apiserver to support auto provisioning of CSP LBs.                                                                                                       | pre-req (users are responsible for setting up [MetalLB](https://metallb.universe.tf/), [kubevip](https://kube-vip.io/), or external LB pointing to NodePorts)                                                               |
| IronBank Image Pull Credentials                                                                                                                                  | Anyone can go to login.dso.mil, and self register against P1's SSO. That can be used to login to registry1.dso.mil to generate image pull credentials for the QuickStart.                                                                                                                                   | BigBang customers are recommended to use ask their BB Customer Liaison's for an IronBank Image pull robot account, which lasts 6 months.                                                                     | [BigBang Releases](https://repo1.dso.mil/platform-one/big-bang/bigbang/-/releases) includes a .tar.gz of IronBank Images                                                                                                    |
| Customer Controlled Private Git Repo (for GitOps, the Cluster needs network access & Credentials for Read Access to said Git Repo)                               | PreSatisfied (the turn key demo points to public repo1, but you won't be able to customize it)                                                                                                                                                                                                              | pre-req (or follow Air gap docs)                                                                                                                                                                             | Air gap docs assist with provisioning an ssh based this                                                                                                                                                                     |
| Use SOPS + CSP KMS or PGP to encrypt secrets that need to be stored in the GitRepo                                                                               | PreSatisfied (Demo Repo has mock secrets encrypted with a demo PGP public encryption key)                                                                                                                                                                                                                   | pre-req (CSP KMS is more secure)                                                                                                                                                                             | pre-req (Use CSP KMS if available, PGP works universally, [Flux requires the private PGP key to not have a passphrase](https://toolkit.fluxcd.io/guides/mozilla-sops/#generate-a-gpg-key))                                  |
| Install and Configure Flux (Flux needs Git Repo Credentials & CSP IAM rights for KMS decryption or a kubernetes secret containing a private PGP decryption key ) | PreSatisfied (Demo Public Repo doesn't require RO Credentials, the demo PGP private decryption key is hosted cleartext in the repo)                                                                                                                                                                         | pre-req (see bigbang docs, [flux docs](https://toolkit.fluxcd.io/components/source/gitrepositories/#spec-examples) are also a good resource for this)                                                        | pre-req (see bigbang docs)                                                                                                                                                                                                  |
| HTTPS Certificates                                                                                                                                               | PreSatisfied (Demo Public Repo contains a Let's Encrypt Free (public internet recognised certificate authority) HTTPS Certificate for *.bigbang.dev, alternatively mkcert can be used to generate demo certs for arbitrary DNS names that will only be trusted by the laptop that provisoned the mkcert)    | pre-req (provided by user)                                                                                                                                                                                   | pre-req (provided by user)                                                                                                                                                                                                  |
| DNS                                                                                                                                                              | Edit your Laptop's host file (/etc/hosts, C:\Windows\System32\drivers\etc\hosts), or use something like AWS VPC Private DNS and [sshuttle](https://github.com/sshuttle/sshuttle) to point to host VM in the case of k3d                                                                                     | pre-req (point DNS names to Layer 4 CSP LB)                                                                                                                                                                  | pre-req (point DNS names to L4 LB)                                                                                                                                                                                          |
| HTTPS Certificate, DNS Name, and hostnames in BigBang's values.yaml must match in order for Ingress to work correctly.                                           | QuickStart leverages *.bigbang.dev HTTPS cert, and the BigBang Helm Chart's values.yaml's hostname defaults to bigbang.dev, just need to ensure multiple hostfile entries like "grafana.bigbang.dev <k3d VM's IP>" exist, or if you have access to DNS a wildcard entry to map *.bigbang.dev to k3d VM's IP | pre-req                                                                                                                                                                                                      | pre-req                                                                                                                                                                                                                     |
| SSO Identity Provider (pre-requisite for SSO Authentication Proxy feature)                                                                                       | PreSatisfied* (*depending on which quick start config is used), There's exists a demo SSO config that leverages P1's CAC enabled SSO, it's coded to only work for localhost to balance turn key demo functionality against security concerns.                                                               | pre-req (You don't have to use keycloak, you can use any OIDC Identity Provider) ([Customer Deployable Keycloak is a feature coming soon](https://repo1.dso.mil/platform-one/big-bang/bigbang/-/issues/291)) | pre-req (You don't have to use keycloak, you can use any OIDC Identity Provider) ([Customer Deployable Keycloak is a feature coming soon](https://repo1.dso.mil/platform-one/big-bang/bigbang/-/issues/291))                |
| Ops team to integrate, configure, and maintain BigBang in Production                                                                                             | NA for Demo                                                                                                                                                                                                                                                                                                 | pre-req* (*[P1 Customer Success can help with this](https://p1.dso.mil/#/services))                                                                                                                          | pre-req* (*[P1 Customer Success can help with this](https://p1.dso.mil/#/services))                                                                                                                                         |

**Table Notes:** 
1. OS Configuration Pre-Requisites: 
   * BigBang can work with selinux enforcing, but it requires additional OS configuration. 
   * The following OS configuration settings are usually required to make BigBang work:
     * `sudo sysctl -w vm.max_map_count=262144`    #(ECK crash loops without this)
     * `sudo setenforce 0`   #(Istio init-container crash loops without this if selinux is enabled) (WIP to remove this requirement in the future/consider disabling it a soft requirement)

2. Kubernetes Cluster Preconfigured to Best Practices: 
   * All Kubernetes Nodes and the LB associated with the kube-apiserver should all use private IPs.
   * In most case User Application Facing LBs should have Private IP Addresses and be paired with a defense in depth Ingress Protection mechanism like [P1's CNAP](https://p1.dso.mil/#/products/cnap/), a CNAP equivalent, VPN, VDI, port forwarding through a bastion, or air gap deployment. 
   * BigBang doesn't support PSPs (Pod Security Policies), because [PSP's are being removed from Kubernetes and will be gone by version 1.25.x](https://repo1.dso.mil/platform-one/big-bang/bigbang/-/issues/10), thus we recommened users disable them: 
   ```bash
   kubectl patch psp system-unrestricted-psp -p '{"metadata": {"annotations":{"seccomp.security.alpha.kubernetes.io/allowedProfileNames": "*"}}}'
   kubectl patch psp global-unrestricted-psp -p '{"metadata": {"annotations":{"seccomp.security.alpha.kubernetes.io/allowedProfileNames": "*"}}}'
   kubectl patch psp global-restricted-psp -p '{"metadata": {"annotations":{"seccomp.security.alpha.kubernetes.io/allowedProfileNames": "*"}}}'
   ```
   * Make sure CoreDNS in the kube-system namespace is HA with pod anti-affinity rules, master nodes are HA and tainted. 
   * Ideally you want to use a default storage class that allows worker nodes in different AZs to mount the same volume (AWS's EBS storage class has a limitation where a PVC in AZ1, can't automatically be mounted by a worker node in AZ2 if AZ1 goes down.)
   * Some BigBang apps allow overriding the storage class, so you can mix multiple storage classes.
   * Some apps require a RWX storage class for HA, so it may make sense to leverage both AWS's EBS storage class and their EFS-CSI storage class. Otherwise Cloud Agnostic Storage Class solutions. 


## Additional Useful Background Contextual Information: 
* We are still migrating some docs from IL2 Confluence, and the BigBang Onboarding Engineering Cohort into to this repo's /docs folder, the planned future state is for this to be a primary location for docs going forward. (Any docs hosted in other repos, will at least have pointers hosted here.)
* There are multiple implementations of Helm Charts (Helm Repos, .tgz, and files and folders in a git repo), whenever P1 refers to a helm chart we're always referring to the files and folders in a git repo implementation, which is stored in /chart folder in a git repo.
* Additional pre-reading materials to develop a better understanding of BigBang before deploying can be found in this understanding_bigbang folder. 
* If you see an issue with docs or packages, please [open an issue against the main BigBang Repo](https://repo1.dso.mil/platform-one/big-bang/bigbang/-/issues), instead of the individual package repo. 
