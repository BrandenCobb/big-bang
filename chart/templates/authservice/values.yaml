{{- if and .Values.istio.enabled .Values.addons.authservice.enabled }}
{{- include "values-secret" (dict "root" $ "package" .Values.addons.authservice "name" "authservice" "defaults" (include "bigbang.defaults.authservice" .)) }}
{{- end }}
{{- $hostname := .Values.hostname -}}

{{- define "bigbang.defaults.authservice" -}}
imagePullSecrets:
  - name: private-registry

global:
  oidc:
    host: {{ .Values.sso.oidc.host }}
    realm: {{ .Values.sso.oidc.realm }}

  {{- if .Values.sso.jwks }}
  jwks: "{{ .Values.sso.jwks }}"
  {{- end }}

  {{- if .Values.sso.client_id}}
  client_id: {{ .Values.sso.client_id }}
  {{- end }}

  {{- if .Values.sso.client_secret }}
  client_secret: {{ .Values.sso.client_secret }}
  {{- end }}

  {{- if .Values.sso.certificate_authority }}
  certificate_authority: {{ .Values.sso.certificate_authority  }}
  {{- end }}

chains:
  {{- if .Values.addons.authservice.chains }}
  {{ .Values.addons.authservice.chains | toYaml | nindent 2 }}
  {{- end }}

  kiali:
    match:
      header: ":authority"
      prefix: {{ range .Values.istio.sso.kiali.uri }}{{ tpl . $}}{{ end }}
    client_id: {{ .Values.istio.sso.kiali.client_id }}
    client_secret: "{{ .Values.istio.sso.kiali.client_secret }}"
    callback_uri: https://{{ range .Values.istio.sso.kiali.uri }}{{ tpl . $}}{{ end }}/login

  jaeger:
    match:
      header: ":authority"
      prefix: {{ range .Values.istio.sso.jaeger.uri }}{{ tpl . $}}{{ end }}
    client_id: "{{ .Values.istio.sso.jaeger.client_id }}"
    client_secret: "{{ .Values.istio.sso.jaeger.client_secret }}"
    callback_uri: https://{{ range .Values.istio.sso.jaeger.uri }}{{ tpl . $}}{{ end }}/login

  prometheus:
    match:
      header: ":authority"
      prefix: {{ range .Values.monitoring.sso.prometheus.uri }}{{ tpl . $}}{{ end }}
    client_id: {{ .Values.monitoring.sso.prometheus.client_id }}
    client_secret: "{{ .Values.monitoring.sso.prometheus.client_secret }}"
    callback_uri: https://{{ range .Values.monitoring.sso.prometheus.uri }}{{ tpl . $}}{{ end }}/login/generic_oauth

  alertmanager:
    match:
      header: ":authority"
      prefix: {{ range .Values.monitoring.sso.alertmanager.uri }}{{ tpl . $}}{{ end }}
    client_id: {{ .Values.monitoring.sso.alertmanager.client_id }}
    client_secret: "{{ .Values.monitoring.sso.alertmanager.client_secret }}"
    callback_uri: https://{{ range .Values.monitoring.sso.alertmanager.uri }}{{ tpl . $}}{{ end }}/login/generic_oauth

{{- end -}}
